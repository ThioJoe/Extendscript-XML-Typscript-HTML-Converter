<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML to .d.ts Converter</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --primary-color: #0d6efd;
            --secondary-bg-color: #2a2a2a;
            --border-color: #444;
            --success-color: #20c997;
            --error-color: #f85149;
            --muted-text-color: #888;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #f5f5f5;
        }

        #drop-zone {
            border: 3px dashed var(--primary-color);
            border-radius: 10px;
            padding: 50px;
            text-align: center;
            color: var(--muted-text-color);
            font-size: 1.2em;
            transition: background-color 0.2s, border-color 0.2s;
        }

        #drop-zone.dragover {
            background-color: var(--secondary-bg-color);
            border-color: #3d8bfd;
            color: var(--text-color);
        }

        .file-input-container {
            text-align: center;
            margin: 20px 0;
        }
        
        #file-input::file-selector-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        #file-input::file-selector-button:hover {
            background-color: #3d8bfd;
        }

        #save-all-btn {
            display: none; /* Hidden by default */
            cursor: pointer;
            background-color: var(--success-color);
            color: #111;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: bold;
            margin: 20px auto;
            transition: background-color 0.2s;
        }
        
        #save-all-btn:hover {
             background-color: #48dac1;
        }

        #results {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--secondary-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }

        .status-message {
            font-style: italic;
            color: var(--muted-text-color);
        }

        .error-message {
            color: var(--error-color);
            font-weight: bold;
        }
        
        .success-message {
            color: var(--success-color);
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h1>XML to .d.ts Converter</h1>

    <div id="drop-zone">
        <p>ðŸ“‚<br>Drag & Drop XML files here</p>
    </div>

    <div class="file-input-container">
        <p>or</p>
        <label for="file-input">Select files:</label>
        <input type="file" id="file-input" multiple accept=".xml,text/xml">
    </div>
    
    <div id="results">
        <p class="status-message">Waiting for files...</p>
    </div>

    <div style="text-align:center;">
        <button id="save-all-btn">Save</button>
    </div>

    <script src="index.js"></script>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const resultsDiv = document.getElementById('results');
        const saveAllButton = document.getElementById('save-all-btn');

        let generatedFiles = []; // Stores { name: string, content: string }

        // --- Drag and Drop Event Listeners ---
        dropZone.addEventListener('dragover', (event) => {
            event.preventDefault(); // Necessary to allow dropping
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (event) => {
            event.preventDefault();
            dropZone.classList.remove('dragover');
            const files = event.dataTransfer.files;
            if (files.length) {
                handleFiles(Array.from(files));
            }
        });

        // --- File Input Listener ---
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                handleFiles(Array.from(fileInput.files));
                fileInput.value = ''; // Reset for re-selection of the same file
            }
        });

        // --- Central File Processing Logic ---
        async function handleFiles(files) {
            resultsDiv.innerHTML = '<p class="status-message">Processing...</p>';
            generatedFiles = []; // Clear previous results

            for (const file of files) {
                if (file.type === 'text/xml' || file.name.endsWith('.xml')) {
                    try {
                        const xmlText = await file.text();
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(xmlText, "application/xml");

                        const parseError = xmlDoc.querySelector('parsererror');
                        if (parseError) {
                            throw new Error(`XML parsing error in ${file.name}: ${parseError.textContent}`);
                        }

                        // Call your existing conversion function
                        const dtsContent = window.convertXmlDomToDts(xmlDoc);
                        const originalName = file.name.replace(/\.xml$/i, '');
                        generatedFiles.push({ name: `${originalName}.d.ts`, content: dtsContent });

                    } catch (error) {
                        console.error(error);
                        const message = document.createElement('p');
                        message.className = 'error-message';
                        message.textContent = error.message;
                        resultsDiv.appendChild(message);
                    }
                } else {
                     const message = document.createElement('p');
                     message.textContent = `Skipping non-XML file: ${file.name}`;
                     resultsDiv.appendChild(message);
                }
            }
            
            // Update UI after processing
            let resultHTML = `<p class="status-message">Converted ${generatedFiles.length} of ${files.length} files.</p>`;
            resultsDiv.innerHTML = resultHTML;

            if (generatedFiles.length > 0) {
                saveAllButton.style.display = 'block';
                if (generatedFiles.length === 1) {
                    saveAllButton.textContent = 'Save As...';
                } else {
                    saveAllButton.textContent = 'Save All to Directory';
                }
            } else {
                saveAllButton.style.display = 'none';
            }
        }

        // --- Save to Directory Logic ---
        saveAllButton.addEventListener('click', async () => {
            if (generatedFiles.length === 0) {
                return;
            }

            // If there's only one file, trigger a simple "Save As" dialog
            if (generatedFiles.length === 1) {
                const file = generatedFiles[0];
                const blob = new Blob([file.content], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = file.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                return; // Stop here
            }

            // --- For MULTIPLE files, use the directory picker ---
            if ('showDirectoryPicker' in window) {
                try {
                    const dirHandle = await window.showDirectoryPicker();
                    const existingFileNames = new Set();
                    for await (const entry of dirHandle.values()) {
                        existingFileNames.add(entry.name);
                    }

                    for (const file of generatedFiles) {
                        let fileName = file.name;
                        let counter = 2;
                        
                        while (existingFileNames.has(fileName)) {
                            const nameWithoutExt = file.name.replace(/\.d\.ts$/, '');
                            fileName = `${nameWithoutExt}-${counter}.d.ts`;
                            counter++;
                        }
                        existingFileNames.add(fileName);

                        const fileHandle = await dirHandle.getFileHandle(fileName, { create: true });
                        const writable = await fileHandle.createWritable();
                        await writable.write(file.content);
                        await writable.close();
                    }
                    resultsDiv.innerHTML += '<p class="success-message">âœ… Files saved successfully!</p>';
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Error saving files:', err);
                        resultsDiv.innerHTML += `<p class="error-message">Could not save files. See console for details.</p>`;
                    }
                }
            } else {
                // Fallback for older browsers (for multiple files)
                alert("Your browser doesn't support saving to a directory. Each file will be downloaded individually.");
                for (const file of generatedFiles) {
                    const blob = new Blob([file.content], { type: 'text/plain;charset=utf-8' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = file.name;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                }
            }
        });
    </script>
</body>
</html>