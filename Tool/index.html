<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML & DLL to .d.ts Converter</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --primary-color: #0d6efd;
            --secondary-bg-color: #2a2a2a;
            --border-color: #444;
            --success-color: #20c997;
            --error-color: #f85149;
            --muted-text-color: #888;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #f5f5f5;
        }

        h3 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 30px;
        }

        .drop-zone {
            border: 3px dashed var(--border-color);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            color: var(--muted-text-color);
            font-size: 1.1em;
            transition: all 0.2s;
            margin-bottom: 20px;
            background: var(--secondary-bg-color);
        }

        .drop-zone.dragover {
            background-color: #3d3d3d;
            border-color: var(--primary-color);
            color: var(--text-color);
        }

        .drop-zone.active {
            border-color: var(--success-color);
        }

        input[type="file"] {
            display: none;
        }

        .btn-select {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .btn-select:hover {
            background-color: #3d8bfd;
        }

        #save-all-btn {
            display: none;
            cursor: pointer;
            background-color: var(--success-color);
            color: #111;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: bold;
            margin: 30px auto;
            transition: background-color 0.2s;
        }

        #save-all-btn:hover {
            background-color: #48dac1;
        }

        #results {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--secondary-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            min-height: 50px;
        }

        .file-list {
            text-align: left;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }

        .status-message {
            font-style: italic;
            color: var(--muted-text-color);
        }

        .error-message {
            color: var(--error-color);
            font-weight: bold;
        }

        .success-message {
            color: var(--success-color);
            font-weight: bold;
        }
    </style>
</head>

<body>

    <h1>ExtendScript DOM Parser</h1>

    <h3>1. XML Definitions</h3>
    <div id="xml-zone" class="drop-zone">
        <p>üìÇ Drag & Drop XML files here</p>
        <button class="btn-select" onclick="document.getElementById('xml-input').click()">Select XMLs</button>
        <input type="file" id="xml-input" multiple accept=".xml,text/xml">
        <div id="xml-list" class="file-list"></div>
    </div>

    <h3>2. Binaries (Optional fix for broken XML)</h3>
    <div id="dll-zone" class="drop-zone">
        <p>‚öôÔ∏è Drag & Drop DLL/Binary files here (e.g. Batch.dll)</p>
        <button class="btn-select" onclick="document.getElementById('dll-input').click()">Select DLLs</button>
        <input type="file" id="dll-input" multiple accept=".dll,.exe,.rpl,application/x-msdownload">
        <div id="dll-list" class="file-list"></div>
    </div>

    <div id="results">
        <p class="status-message">Ready.</p>
    </div>

    <div style="text-align:center;">
        <button id="save-all-btn">Process & Save</button>
    </div>

    <script src="index.js"></script>

    <script>
        const ui = {
            xml: { zone: document.getElementById('xml-zone'), input: document.getElementById('xml-input'), list: document.getElementById('xml-list'), files: [] },
            dll: { zone: document.getElementById('dll-zone'), input: document.getElementById('dll-input'), list: document.getElementById('dll-list'), files: [] },
            results: document.getElementById('results'),
            btn: document.getElementById('save-all-btn')
        };

        let generatedFiles = [];

        function setupDropZone(type) {
            const { zone, input, list, files } = ui[type];

            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                handleFiles(type, e.dataTransfer.files);
            });
            input.addEventListener('change', () => handleFiles(type, input.files));
        }

        function handleFiles(type, newFiles) {
            const targetArray = ui[type].files;
            // Convert FileList to Array and dedup based on name
            Array.from(newFiles).forEach(f => {
                if (!targetArray.find(existing => existing.name === f.name)) {
                    targetArray.push(f);
                }
            });
            renderList(type);
            checkReady();
        }

        function renderList(type) {
            const { list, files, zone } = ui[type];
            list.innerHTML = files.map(f => `<div class="file-item"><span>${f.name}</span><span>${(f.size / 1024).toFixed(1)}KB</span></div>`).join('');
            if (files.length > 0) zone.classList.add('active');
        }

        function checkReady() {
            if (ui.xml.files.length > 0) {
                ui.btn.style.display = 'block';
                ui.results.innerHTML = `<p class="status-message">Ready to process ${ui.xml.files.length} XML files and ${ui.dll.files.length} binaries.</p>`;
            }
        }

        setupDropZone('xml');
        setupDropZone('dll');

        ui.btn.addEventListener('click', async () => {
            ui.results.innerHTML = '<p class="status-message">Processing... this may take a moment.</p>';
            generatedFiles = [];

            try {
                // 1. Load all DLLs into memory first
                const dllBuffers = [];
                for (const file of ui.dll.files) {
                    const buffer = await file.arrayBuffer();
                    dllBuffers.push({ name: file.name, data: new Uint8Array(buffer) });
                }

                // 2. Process XMLs
                for (const file of ui.xml.files) {
                    const xmlText = await file.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "application/xml");

                    if (xmlDoc.querySelector('parsererror')) {
                        throw new Error(`XML Error in ${file.name}`);
                    }

                    // *** CORE PROCESSING ***
                    const dtsContent = window.convertXmlDomToDts(xmlDoc, dllBuffers);

                    const originalName = file.name.replace(/\.xml$/i, '');
                    generatedFiles.push({ name: `${originalName}.d.ts`, content: dtsContent });
                }

                ui.results.innerHTML = `<p class="success-message">‚úÖ Processed ${generatedFiles.length} files!</p>`;
                saveFiles();

            } catch (err) {
                console.error(err);
                ui.results.innerHTML += `<p class="error-message">Error: ${err.message}</p>`;
            }
        });

        async function saveFiles() {
            if (generatedFiles.length === 0) return;

            if ('showDirectoryPicker' in window && generatedFiles.length > 1) {
                try {
                    const dirHandle = await window.showDirectoryPicker();
                    for (const file of generatedFiles) {
                        const fileHandle = await dirHandle.getFileHandle(file.name, { create: true });
                        const writable = await fileHandle.createWritable();
                        await writable.write(file.content);
                        await writable.close();
                    }
                } catch (e) {
                    console.log("Cancelled or error", e);
                }
            } else {
                for (const file of generatedFiles) {
                    const blob = new Blob([file.content], { type: 'text/plain' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = file.name;
                    a.click();
                }
            }
        }
    </script>
</body>

</html>